# Agent Team Monitor 修复日志（2026-02-11）

> 生成时间：2026-02-11 23:50:15 +0800  
> 目的：让 Claude Code 的 agent 能快速、完整理解本轮所有修复。

## 1. 修复范围总览

本轮修复覆盖以下 7 个方向：

1. 构建系统：补充 Windows 构建目标
2. Web 体验：改造成“办公室工位 + 人话对话”场景
3. TUI 体验：与 Web 统一为办公室叙事风格
4. 叙事规则：抽取共享模块，避免 TUI/Web 逻辑漂移
5. 关键缺陷：修复“按成员读取 activity 失真”的根因
6. 回归保障：补充 parser 层表驱动测试
7. 布局修正：`.teams-grid` 改为全宽展示

---

## 2. 关键根因与修复（高优先级）

### 2.1 原问题（已修复）

**问题描述**：项目无法稳定、准确按成员读取 Claude Code agent team 活动，存在同 `cwd` 多成员串线。  
**根因**：旧逻辑按 `cwd` 找到第一个匹配 `agent-*.jsonl` 即停止，导致多个成员共享同一日志。

### 2.2 修复策略

实现“成员身份优先”的日志匹配流程：

1. 优先在 `leadSessionId` 对应 `subagents` 目录中搜索
2. 从日志文本提取身份线索（`你是 {member}` / `You are {member}`）
3. 支持代际别名（例如 `api-developer-2` 可匹配 `api-developer`）
4. 引入 `joinedAt` 时间约束，过滤过早历史会话
5. 多候选时按“距 `joinedAt` 最近”优先，次级按 `LastActiveAt`
6. `team-lead` 额外优先读取 `leadSessionId.jsonl` 主会话日志
7. Scanner 缓冲扩大到 10MB，修复超长 JSONL 行漏读问题

### 2.3 关键文件

- `pkg/parser/activity.go`
- `pkg/parser/team.go`
- `pkg/monitor/collector.go`
- `pkg/types/types.go`

---

## 3. 前后端展示能力升级

### 3.1 Web 办公室场景改造

- 成员展示改为“工位模式 + 对话气泡”
- 对话内容来自任务/思考/工具调用/消息摘要/活跃时间
- 增加“活动中”状态显著高亮（边框、光效、呼吸动画）
- 每行固定 3 个工位（中屏 2 列，小屏 1 列）
- `.teams-grid` 修复为单团队全宽（`auto-fit`）

关键文件：

- `web/static/js/app.js`
- `web/static/css/style.css`

### 3.2 TUI 风格统一

- TUI 同步为“办公室实况 + 人话对白”模式
- 增加角色 emoji、广播工位、任务总览一致化
- 优先消费共享叙事字段（见第 4 节）

关键文件：

- `pkg/ui/tui.go`

---

## 4. 共享叙事规则（防漂移）

新增共享模块：

- `pkg/narrative/office.go`

统一提供：

- 任务归属计算：`GroupTasksByOwner`
- 角色头像：`RoleEmoji`
- 对白生成：`BuildAgentDialogues`
- 时间文案：`FormatRelativeTime`
- 文本截断：`NormalizeDialogText`

Collector 在聚合阶段统一下发字段：

- `members[].role_emoji`
- `members[].office_dialogues`

TUI 与 Web 都优先读取这两项，避免两套文案规则分叉。

---

## 5. API/数据结构增量变化（向后兼容）

以下字段为**新增**（非破坏性）：

- `teams[].lead_session_id`
- `teams[].members[].joined_at`
- `teams[].members[].role_emoji`
- `teams[].members[].office_dialogues`

说明：旧字段仍保留，现有调用方不会因为字段缺失而崩溃。

---

## 6. 构建系统修复

`Makefile` 增加了 Windows 构建支持：

- `make build-windows`（`amd64/arm64`）
- `make build-all` 已包含 Windows 目标

关键文件：

- `Makefile`

---

## 7. 回归测试（新增）

新增测试文件：

- `pkg/parser/activity_test.go`

覆盖场景：

1. 同 `cwd` 多成员不串线（按成员提示词匹配）
2. `-2` 代成员按 `joinedAt` 选择正确会话
3. 超长 JSONL 行仍可匹配（Scanner 缓冲回归）
4. 超长 assistant 行仍可解析 activity（思考/工具）

---

## 8. 本轮改动文件清单

- `Makefile`
- `pkg/monitor/collector.go`
- `pkg/parser/activity.go`
- `pkg/parser/team.go`
- `pkg/types/types.go`
- `pkg/ui/tui.go`
- `web/static/css/style.css`
- `web/static/js/app.js`
- `pkg/narrative/office.go` (new)
- `pkg/parser/activity_test.go` (new)

---

## 9. 验证记录

已执行并通过：

- `go test ./...`
- `go build ./cmd/monitor`
- `go test ./pkg/parser -run 'TestFindAgentLogFileForMember|TestParseAgentActivity' -v`

并使用本机真实数据验证：

- 启动 Web 模式并拉取 `/api/state`
- 核对成员活动不再出现同 `cwd` 的统一串线

---

## 10. 给后续 Claude agents 的工作建议

建议优先阅读顺序：

1. `FIX_LOG_2026-02-11.md`（本文件）
2. `pkg/parser/activity.go`（成员日志匹配核心）
3. `pkg/parser/activity_test.go`（防回归用例）
4. `pkg/monitor/collector.go`（聚合流程）
5. `pkg/narrative/office.go`（统一文案规则）
6. `web/static/js/app.js` 与 `pkg/ui/tui.go`（展示层）

如果要继续演进，优先补充：

- 基于 `leadSessionId + runtime mapping` 的更强身份映射
- parser 层 benchmark（大量历史日志性能评估）
- e2e 快照测试（Web/TUI 的统一文案校验）

